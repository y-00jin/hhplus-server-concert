
# 콘서트 매진 랭킹 설계 보고서

## 1. 기능
- 콘서트 일정 중 가장 빠르게 매진된 일정을 기준으로, 월간 인기 랭킹을 산정하여 사용자에게 제공하는 기능
- 사용자에게 현재 월 기준 TOP-N 콘서트 랭킹을 보여주는 API 제공

## 2. 랭킹 산정 기준

### 좌석 상태 `seats.status`
- 랭킹 산정의 첫 번째 기준은 좌석의 상태이다.
- 좌석 상태(`seats.status`)가 예약 확정(`CONFIRMED`)인 좌석의 수가 해당 콘서트 일정의 전체 좌석 수와 동일해지는 순간을 **매진 완료 시점**으로 간주한다.

### 콘서트 일정 생성일 `concert_schedules.create_at`
- 랭킹 산정의 두 번째 기준은 콘서트 일정 생성일이다.
- 정확한 매진 속도 산정을 위해서는 티켓팅 오픈 시간이 이상적이지만,  테이블 구조 변경 없이 구현하기 위해 콘서트 일정의 생성일(`created_at`)을 예약 시작 시각으로 간주하여 사용한다.

### 랭킹 점수 측정 시점
- 랭킹 점수는 `예약 시작 시점(=일정 생성일)`부터 `매진 완료 시점(=마지막 좌석 결제 확정 시점)`까지 걸린 **경과 시간(초)** 을 기준으로 한다.
- 점수가 낮을수록 빠르게 매진된 일정으로 간주된다.

### 정렬 기준
1. 매진까지 걸린 시간이 짧은 순서 (오름차순)
2. 동점일 경우 일정 생성일 순

## 3. Redis 저장소 설계


| 항목              | 내용                                                |
| --------------- |---------------------------------------------------|
| **Redis 자료구조**  | Sorted Set (`ZADD`, `ZRANGE`)                     |
| **Redis 키 구조**  | `ranking:soldout-time:{yyyyMM}` (`202507` 등 월 단위) |
| **Member**      | `schedule:{scheduleId}`                           |
| **Score**       | `매진까지 걸린 시간 (초)`                                  |
| **보존 기간 (TTL)** | 없음 (월별 Key로 구분하여 TTL 없이 관리, 추후 지난 Key는 배치로 정리 예정) |


## 4. 처리 로직

### 매진 감지 및 랭킹 등록
- 결제 시 `좌석 상태(CONFIRMED)`로 변경되면,
  해당 콘서트 일정의 전체 좌석 수와 확정 좌석 수를 비교하여 **매진 여부를 판별**
- `전체 좌석 수 == CONFIRMED 좌석 수` → 매진 완료로 간주
- 매진이 감지되면 아래 순서로 랭킹 등록 진행
#### 등록 처리 순서:
1. `schedule.created_at`으로부터 현재 시간까지의 경과 시간 계산
2. Redis Key 생성: `ranking:soldout-time:{yyyyMM}`
3. 이미 랭킹 등록 여부 확인 (`ZSCORE`)
4. 등록되지 않은 경우 → `ZADD`로 등록

## ## 5. API 및 사용자 응답

### 조회 API

```http
GET /api/v1/concerts/rankings/soldout?year=2025&month=7&topN=5
```


### 응답 DTO 예시

```json
[
  {
    "ranking": 1,
    "scheduleId": 42,
    "concertDate": "2025-07-20"
  },
  {
    "ranking": 2,
    "scheduleId": 15,
    "concertDate": "2025-07-10"
  }
]

```

> 응답에는 랭킹 순번을 함께 포함시켜, 사용자에게 정렬 순서를 명확히 전달



## 6. 정리
- Redis 기반 Sorted Set을 활용한 월간 매진 랭킹 시스템 구현
- 결제 시점에서 매진 여부를 실시간 감지 후 등록
- 월별 Key 구분으로 TTL 없이 관리하며, 추후 지난 월 Key는 배치 등으로 정리 예정
- 콘서트 API 응답에 랭킹 순위 포함
- 향후 주간/일간 랭킹 확장도 유연하게 가능